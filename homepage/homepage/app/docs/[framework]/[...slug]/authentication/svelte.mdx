export const metadata = { title: "Authentication methods" };

import { CodeGroup } from "@/components/forMdx";

# Authentication in Jazz

When a user loads a Jazz application for the first time an anoymous account is created.

The users can do everything normally, but the account credentials are stored only locally.

To give users the ability of use the same account on multiple devices they need to be authenticated with
one of Jazz authentication providers:
- Passkey
- Passphrase

The registration process will keep the user credentials intact and just safely store them on the selected provider.

Schematically the authentication flow works like this:
1. The user loads the app
  a. If it's the first time a new anonymous account is created
  b. Otherwise the last used account is loaded from the local storage
2. The user tries to authenticate
  a. When the user performs a signIn, the current account credentials are registered in the selected provider
  b. If instead logs-in the local credentials are deleted and the authenticated account is loaded

When the credentials of an anonymous account are deleted they are forever lost, 
but data can be migrated to the authenticated account using the `onAnonymousAccountDiscarded` handler (docs below).

## Passkey

The passkey authentication is fully local-first and the most secure of the auth methods that Jazz provides.

It is based on the [Web Authentication API](https://developer.mozilla.org/en-US/docs/Web/API/Web_Authentication_API) and also very easy to use and widely supported.

For this reasons this is the recommended authentication method to use with Jazz.

### How to use

1. Setup up Jazz as described in the [setup guide](/docs/project-setup)

2. Use the `usePasskeyAuth` hook to authenticate (must be used inside `JazzProvider`)

<CodeGroup>
```ts
import { usePasskeyAuth } from "jazz-svelte";

const auth = usePasskeyAuth({ appName });

let error = $state<string | undefined>(undefined);

function signUp(e: Event) {
  const formData = new FormData(e.currentTarget as HTMLFormElement);
  const name = formData.get('name') as string;

  if (!name) {
    error = 'Name is required';
    return;
  }
  e.preventDefault();
  error = undefined;
  auth.current.signUp(name).catch((e) => {
    error = e.message;
  });
}

function logIn() {
  error = undefined;
  auth.current.logIn().catch((e) => {
    error = e.message;
  });
}
```
</CodeGroup>

Take a look at our [example](https://github.com/garden-co/jazz/tree/main/examples/passkey-svelte) to see how it works.


## Passphrase

Passphrase authentication generates a menemonic password from the local account certificate that can be used to logIn.

The storage of such password is left to the user and so it's security.

### How to use

1. Setup up Jazz as described in the [setup guide](/docs/project-setup).

2. Use the `usePassphraseAuth` hook to show the current account passphrase, sign up or to log in. (must be used inside `JazzProvider`)

<CodeGroup>
```ts
import { usePassphraseAuth } from "jazz-svelte";

// ...

const auth = usePassphraseAuth({ wordlist });
```
</CodeGroup>

The `signUp` function can be used to track that the user has registered the passphrase and is not anymore anonymous.

The wordlist is a list of 2048 words, you can find one for your language [here](https://github.com/bitcoinjs/bip39/tree/a7ecbfe2e60d0214ce17163d610cad9f7b23140c/src/wordlists).

## Migrating data from anonymous to authenticated account

With Jazz is possible to make anonymous accounts to use the app normally, but when the user logs in with an existing account the anonymous account gets replaced by the authenticated one.

It may be that the user didn't recognize that it was using an anonymous account and might create stuff while anonymous that they don't want to lose.

To avoid this situation is possible to use the `onAnonymousAccountDiscarded` handler to migrate the data from the anonymous account to the authenticated one.

This is an example from our [music player](https://github.com/garden-co/jazz/tree/main/examples/music-player):
<CodeGroup>
```ts
export async function onAnonymousAccountDiscarded(
  anonymousAccount: MusicaAccount,
) {
  const { root: anonymousAccountRoot } = await anonymousAccount.ensureLoaded({
    root: {
      rootPlaylist: {
        tracks: [{}],
      },
    },
  });

  const me = await MusicaAccount.getMe().ensureLoaded({
    root: {
      rootPlaylist: {
        tracks: [],
      },
    },
  });

  for (const track of anonymousAccountRoot.rootPlaylist.tracks) {
    if (track.isExampleTrack) continue;

    const trackGroup = track._owner.castAs(Group);
    trackGroup.addMember(me, "admin");

    me.root.rootPlaylist.tracks.push(track);
  }
}
```
</CodeGroup>

## Disable network sync for anonymous users

A great way to get you users to try your app for free is to make it local-only for anonymous users.

With `sync.when` set to `signedUp` the app will work in local mode when the user is anonymous and the user will unlock the multiplayer & multi-device features when they sign up.

<CodeGroup>
```ts
<JazzProvider
  sync={{
    peer: `wss://cloud.jazz.tools/?key=${apiKey}`,
     // This makes the app work in local mode when the user is anonymous
    when: "signedUp",
  }}
>
  <App />
</JazzProvider>
```
</CodeGroup>
