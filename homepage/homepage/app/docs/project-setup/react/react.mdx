import { CodeGroup } from "@/components/forMdx";

# <span id="react">React</span>

Currently, the recommended pattern to set up a React app with Jazz is to create a separate file (for example, called `jazz.tsx`) in which:

1. You create a new Jazz React app context, extracting and exporting Jazz hooks.

    <CodeGroup>
    {/* prettier-ignore */}
    ```tsx
    import { createJazzReactApp } from "jazz-react";

    const Jazz = createJazzReactApp();
    export const { useAccount, useCoState } = Jazz;
    ```
    </CodeGroup>

    - You extract hooks here so they can be aware of a custom `AccountSchema` for your app once you start using one (see [Accounts & Migrations](/docs/schemas/accounts-and-migrations)).

        This way, accounts returned by the hooks will be correctly typed throughout your app. Simply import them from `jazz.tsx` wherever you need them.

        <CodeGroup>
        {/* prettier-ignore */}
        ```tsx
        import { createJazzReactApp } from "jazz-react"; // old

        const Jazz = createJazzReactApp({ AccountSchema: MyAppAccount });
        export const { useAccount, useCoState } = Jazz; // old
        ```
        </CodeGroup>

2. You define a context providing component (typically called `JazzAndAuth`) that uses

    - the context provider of the Jazz React app context you just created

    - the hooks and default/custom UI of one of the [Auth Methods](/docs/auth/auth-methods).

    This is also where you specify the sync & storage server to connect to (see [Sync and storage](/docs/sync-and-storage)).

    <CodeGroup>
    {/* prettier-ignore */}
    ```tsx
    import { createJazzReactApp } from "jazz-react";// old

    const Jazz = createJazzReactApp();// old
    export const { useAccount, useCoState } = Jazz;// old

    import { PasskeyAuthBasicUI, usePasskeyAuth } from "jazz-react";

    function JazzAndAuth({ children }: { children: React.ReactNode }) {
        const [passkeyAuth, passKeyState] = usePasskeyAuth({ appName });

        return (
            <>
                <Jazz.Provider
                    auth={passkeyAuth}
                    peer="wss://mesh.jazz.tools/?key=you@example.com"
                >
                    {children}
                </Jazz.Provider>
                <PasskeyAuthBasicUI state={passKeyState} />
            </>
        );
    }
    ```
    </CodeGroup>

With `JazzAndAuth` defined, you can wrap your app in it and then use the extracted and exported hooks within your App.

<CodeGroup>
{/* prettier-ignore */}
```tsx
ReactDOM.createRoot(document.getElementById("root")!).render( // old
    <React.StrictMode> // old
        <JazzAndAuth>
            <App />
        </JazzAndAuth>
    </React.StrictMode>// old
);// old
```
</CodeGroup>


# <span id="next">Next.JS</span>

## <span id="next-csr">Client-side only</span>

The easiest way to use Jazz with Next.JS is to only use it on the client side. You can ensure this by:

- marking the `jazz.tsx` file as `"use client"`

    <CodeGroup>
    {/* prettier-ignore */}
    ```tsx
    "use client"
    import { createJazzReactApp } from "jazz-react";// old

    const Jazz = createJazzReactApp();// old
    export const { useAccount, useCoState } = Jazz;// old

    import { PasskeyAuthBasicUI, usePasskeyAuth } from "jazz-react";// old

    function JazzAndAuth({ children }: { children: React.ReactNode }) {// old
        const [passkeyAuth, passKeyState] = usePasskeyAuth({ appName });// old

        return (// old
            <>// old
                <Jazz.Provider// old
                    auth={passkeyAuth}// old
                    peer="wss://mesh.jazz.tools/?key=you@example.com"// old
                >// old
                    {children}// old
                </Jazz.Provider>// old
                <PasskeyAuthBasicUI state={passKeyState} />// old
            </>// old
        );// old
    }// old
    ```
    </CodeGroup>

- marking any file with components where you use Jazz hooks (such as `useAccount` or `useCoState`) as `"use client"`

## <span id="next-ssr">SSR use (experimental)</span>

Pure SSR use of Jazz is basically just using jazz-nodejs (see [Node.JS / Server Workers](/docs/project-setup/server-side)) inside Server Components.

Instead of using hooks as you would on the client, you await promises returned by `CoValue.load(...)` inside your Server Components.

TODO: code example

This should work well for cases like rendering publicly-readable information, since the worker account will be able to load them.

In the future, it will be possible to use trusted auth methods (such as Clerk, Auth0, etc.) that let you act as the same Jazz user both on the client and on the server, letting you use SSR even for data private to that user.

## <span id="next-ssr-plus-csr">SSR + client-side (experimental)</span>

You can combine the two approaches by creating

1. A pure "rendering" component that renders an already-loaded CoValue (in JSON-ified form)

    TODO: code example

2. A "hydrating" component (with `"use client"`) that

    - expects a pre-loaded CoValue as a prop (in JSON-ified form)
    - uses one of the client-side Jazz hooks (such as `useAccount` or `useCoState`) to subscribe to that same CoValue
    - passing the client-side subscribed state to the "rendering" component, with the pre-loaded CoValue as a fallback until the client receives the first subscribed state

    TODO: code example

3. A "pre-loading" Server Component that

    - pre-loads the CoValue by awaiting it's `load(...)` method (as described above)
    - renders the "hydrating" component, passing the pre-loaded CoValue as a prop

    TODO: code example

# <span id="react-native">React Native</span>

Jazz requires an [Expo development build](https://docs.expo.dev/develop/development-builds/introduction/) using [Expo Prebuild](https://docs.expo.dev/workflow/prebuild/) for native code. It is **not compatible** with Expo Go. Jazz also supports the [New Architecture](https://docs.expo.dev/guides/new-architecture/).

Tested with:

<CodeGroup>
```json
"expo": "~51.0.0",
"react-native": "~0.74.5",
"react": "^18.2.0",
```
</CodeGroup>

## <span id="react-native-setup">Setup</span>

### Create a New Project

(skip this step if you already have one)

<CodeGroup>
```bash
npx create-expo-app -e with-router-tailwind my-jazz-app
cd my-jazz-app
npx expo prebuild
```
</CodeGroup>

### Install dependencies

<CodeGroup>
```bash
npx expo install expo-linking expo-secure-store expo-file-system @react-native-community/netinfo @bam.tech/react-native-image-resizer

npm i -S react-native-polyfill-globals react-native-url-polyfill web-streams-polyfill@3.2.1 base-64 text-encoding react-native-fetch-api react-native-get-random-values buffer

npm i -D @babel/plugin-transform-class-static-block

npm i -S jazz-tools jazz-react-native jazz-react-native-media-images

```
</CodeGroup>

### Fix Incompatible Dependencies

<CodeGroup>
```bash
npx expo install --fix
```
</CodeGroup>

### Install Pods

<CodeGroup>
```bash
npx pod-install
```
</CodeGroup>

### Configure Metro

#### Regular Repositories

If you are not working within a monorepo, create a new file metro.config.js in the root of your project with the following content:

<CodeGroup>
```ts
const { getDefaultConfig } = require("expo/metro-config");
const config = getDefaultConfig(projectRoot);
config.resolver.unstable_enablePackageExports = true; // important setting
config.resolver.sourceExts = ["mjs", "js", "json", "ts", "tsx"];
config.resolver.requireCycleIgnorePatterns = [/(^|\/|\\)node_modules($|\/|\\)/];
module.exports = config;
```
</CodeGroup>

If you created the project using the command `npx create-expo-app -e with-router-tailwind my-jazz-app`, then `metro.config.js` is already present. In that case, simply add this setting to the existing file:

<CodeGroup>
```ts
config.resolver.unstable_enablePackageExports = true
```
</CodeGroup>

#### Monorepos

For monorepos, use the following metro.config.js:

<CodeGroup>
```ts
const { getDefaultConfig } = require("expo/metro-config");
const { FileStore } = require("metro-cache");
const path = require("path");

// eslint-disable-next-line no-undef
const projectRoot = __dirname;
const workspaceRoot = path.resolve(projectRoot, "../..");

const config = getDefaultConfig(projectRoot);

config.watchFolders = [workspaceRoot];
config.resolver.nodeModulesPaths = [
    path.resolve(projectRoot, "node_modules"),
    path.resolve(workspaceRoot, "node_modules"),
];
config.resolver.sourceExts = ["mjs", "js", "json", "ts", "tsx"];
config.resolver.unstable_enablePackageExports = true;
config.resolver.requireCycleIgnorePatterns = [/(^|\/|\\)node_modules($|\/|\\)/];
config.cacheStores = [
    new FileStore({
        root: path.join(projectRoot, "node_modules", ".cache", "metro"),
    }),
];

module.exports = config;
```
</CodeGroup>

### Additional Monorepo Configuration (for pnpm users)

- Add node-linker=hoisted to the root .npmrc (create this file if it doesnâ€™t exist).
- Add the following to the root package.json:

<CodeGroup>
```json
"pnpm": {
    "peerDependencyRules": {
        "ignoreMissing": [
            "@babel/*",
            "expo-modules-*",
            "typescript"
        ]
    }
}
```
</CodeGroup>

For more information, refer to [this](https://github.com/byCedric/expo-monorepo-example#pnpm-workarounds) Expo monorepo example.

### Configure Babel

Add `@babel/plugin-transform-class-static-block` to the array of Babel plugins inside `babel.config.js`:

<CodeGroup>
```ts
module.exports = function (api) {
    api.cache(true);
    return {
        presets: ["babel-preset-expo"],
        plugins: [
            "nativewind/babel",
            "@babel/plugin-transform-class-static-block",
        ],
    };
};
```
</CodeGroup>

### Add Polyfills

Create a file `polyfills.js` at the project root with the following content:

<CodeGroup>
```ts
import "react-native-polyfill-globals/auto";
import "@azure/core-asynciterator-polyfill";
import { ReadableStream } from "web-streams-polyfill/ponyfill/es6";
import { polyfillGlobal } from "react-native/Libraries/Utilities/PolyfillFunctions";
import { Buffer } from "buffer";

polyfillGlobal("Buffer", () => Buffer);
polyfillGlobal("ReadableStream", () => ReadableStream);
```
</CodeGroup>

Update `index.js` based on whether you are using expo-router or not:

#### If using `expo-router`

<CodeGroup>
```ts
import "./polyfills";
import "expo-router/entry";
```
</CodeGroup>

#### Without `expo-router`

<CodeGroup>
```ts
import "./polyfills";
import { registerRootComponent } from "expo";
import App from "./src/App";
registerRootComponent(App);
```
</CodeGroup>

Lastly, ensure that the `"main"` field in your `package.json` points to `index.js`:

<CodeGroup>
```json
"main": "index.js",
```
</CodeGroup>

## <span id="react-native-using-jazz">Using Jazz</span>

### `createJazzRNApp()`

Create a file `jazz.tsx` with the following contents:

<CodeGroup>
```tsx
import { createJazzRNApp } from "jazz-react-native";

export const Jazz = createJazzRNApp();
export const { useAccount, useCoState, useAcceptInvite } = Jazz;
```
</CodeGroup>

You can optionally pass a custom `kvStore` and `AccountSchema` to `createJazzRNApp()`, otherwise, it defaults to `ExpoSecureStoreAdapter` and `Account`.

### Choosing an Auth Method

Refer to the Jazz + React Native demo projects for implementing authentication:

- [DemoAuth Example](https://github.com/gardencmp/jazz/tree/main/examples/chat-rn)
- [ClerkAuth Example](https://github.com/gardencmp/jazz/tree/main/examples/chat-rn-clerk)

In the demos, you'll find details on:

- Using Jazz.Provider with your chosen authentication method
- Defining a Jazz schema
- Creating and subscribing to covalues
- Handling invites

### Working with Images

To work with images in Jazz, import the `createImage` function from [`jazz-react-native-media-images`](https://github.com/gardencmp/jazz/tree/main/packages/jazz-react-native-media-images).

<CodeGroup>
```tsx
import { createImage } from "jazz-react-native-media-images";

const base64ImageDataURI = "data:image/png;base64,...";

const image = await createImage(base64ImageDataURI, {
    owner: newPetPost._owner,
    maxSize: 2048, // optional: specify maximum image size
});

someCovalue.image = image;
```
</CodeGroup>

For a complete implementation, please refer to [this](https://github.com/gardencmp/jazz/blob/main/examples/pets/src/3_NewPetPostForm.tsx) demo.

### Running Your App

<CodeGroup>
```bash
npx expo run:ios
npx expo run:android
```
</CodeGroup>
